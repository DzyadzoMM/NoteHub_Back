Скидання паролю через email
Налаштування пошти
Створіть акаунт на brevo.com. Цей сервіс буде використаний для надсилання повідомлень електронною поштою.
Підключіться до SMTP-сервера Brevo за допомогою пакету nodemailer.

Надсилання email для скидання паролю
Створіть роут POST /auth/request-reset-email, який буде надсилати email для скидання паролю. В body він має приймати емейл користувача (властивість email). Обробка цього роута має включати:
1. Опис роута POST /auth/request-reset-email у файлі src/routes/authRoutes.js.
2. Для маршруту POST /auth/request-reset-email потрібно валідувати тіло запиту як об’єкт із наступними властивостями:
email - рядок типу email, обов’язкове поле.
3. Для цього створіть схему валідації requestResetEmailSchema у файлі src/validations/authValidation.js.
4. Опис контролера requestResetEmail для цього роута у файлі src/controllers/authController.js:
Знайдіть користувача за переданим email. Якщо користувача не знайдено, то поверніть відповідь зі сатусом 200 і повідомленням:
{ message: 'Password reset email sent successfully' }
Згенеруйте JWT-токен, який містить sub (id користувача) та email. Термін життя токена — 15 хвилин.
Зробіть HTML-лист на основі шаблону src/templates/reset-password-email.html (використовуйте handlebars для підстановки даних, таких як ім’я користувача та посилання).
Посилання в листі має вести на фронтенд (домен береться з env-змінної FRONTEND_DOMAIN) та мати вигляд:
<FRONTEND_DOMAIN>/reset-password?token=<jwt-token>
Використайте утиліту sendEmail з файлу src/utils/sendMail.js для надсилання листа з посиланням для скиду паролю. В цій утиліті за допомогою пакету nodemailer організуйте відправку емейла користувачу.
Якщо надсилання листа не вдалося, то використовуючи бібліотеку createHttpError поверніть відповідь зі сатусом 500 і повідомленням 'Failed to send the email, please try again later.'.
У разі успіху поверніть відповідь зі статусом 200 і повідомленням:
{ message: 'Password reset email sent successfully' }

Усі чутливі дані, які використовуються при цьому винесіть у файл .env:
# Значення беремо із акаунта Brevo
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASSWORD=
# Пошта на яку реєстрували акаунт brevo.com
SMTP_FROM=
# Довільний рядок для генерації підпису токена
JWT_SECRET=
# Домен фронтенда на який буде вести посилання в листі
# Наприклад <http://localhost:3001>
FRONTEND_DOMAIN=

Скидання паролю
Створіть роут POST /auth/reset-password, який буде скидати пароль. В body він має приймати:
властивість token - JWT токен, який був переданий у посилання для скиду паролю в попередньому кроці;
властивість password - новий пароль.

Обробка цього роута має включати:
1. Опис роута POST /auth/reset-password у файлі src/routes/authRoutes.js.
2.Для маршруту POST /auth/reset-password потрібно валідувати тіло запиту як об’єкт із наступними властивостями:
password - рядок, обов’язкове поле;
token - рядок, обов’язкове поле;
3. Для цього створіть схему валідації resetPasswordSchema у файлі src/validations/authValidation.js.
4. Опис контролера resetPassword для цього роута у файлі src/controllers/authController.js:
Верифікуйте отриманий в тілі запиту jwt-токен. Якщо токен невалідний або прострочений, використовуючи бібліотеку createHttpError, поверніть відповідь зі статусом 401 і повідомленням 'Invalid or expired token'.
Знайдіть користувача за sub та email, які містяться в токені. Якщо користувача не знайдено, використовуючи бібліотеку createHttpError, поверніть відповідь зі статусом 404 і повідомленням 'User not found'.
Зашифруйте новий пароль за допомогою бібліотеки bcrypt.
Оновіть пароль користувача в базі даних.
У разі успіху поверніть відповідь зі статусом 200 та повідомленням:
{
	message: 'Password reset successfully'
}



Аватар користувача



Розширте функціонал вашого серверу, додавши можливість завантажувати зображення для аватарки користувача.



Налаштування Cloudinary



Створіть акаунт на Cloudinary.

У .env винесіть налаштування для Cloudinary:

CLOUDINARY_CLOUD_NAME=
CLOUDINARY_API_KEY=
CLOUDINARY_API_SECRET=



Модель користувача



У src/models/user.js додайте поле avatar. Тип String, необов’язкове поле, дефолтне значення:

 https://ac.goit.global/fullstack/react/default-avatar.jpg



За допомогою хука pre("save") налаштуйте, щоб значення властивості username автоматично встановлювалося таким самим, як у email.



Завантаження аватара



Створіть роут PATCH /users/me/avatar, який буде оновлювати аватар користувача. В body він має приймати:

властивість avatar - файл із зображенням для аватарки користувача.


Обробка цього роута має включати:

1. Реєстрацію загального роута користувача в файлі src/server.js.

2. Опис роута PATCH /users/me/avatar у файлі src/routes/userRoutes.js.

3. Для маршруту PATCH /users/me/avatar потрібно:

реалізувати захист маршруту, щоб до нього доступ був тільки у авторизованого користувача
обробити файл із зображенням для аватарки користувача через middleware upload.
Для цього створіть middleware upload у файлі src/middleware/multer.js, який:

зберігає файл у пам’яті (memoryStorage);
обмежує розмір файлу до 2MB;
дозволяє тільки файли з mimetype, що починається з image/. У випадку невідповідності повертає помилку "Only images allowed".
4. Реалізацію утиліти для збереження файлу в хмарне сховище у файлі src/utils/saveFileToCloudinary.js:

використайте бібліотеку cloudinary;
реалізуйте функцію saveFileToCloudinary(buffer), яка приймає буфер файлу та повертає проміс, який резолвить об’єкт із даними завантаженого зображення;
завантаження організуйте через cloudinary.uploader.upload_stream та Node.js Readable стрім.
5. Опис контролера updateUserAvatar для цього роута у файлі src/controllers/userController.js:

Перевірте наявність файлу у реквесті, у разі його відсутності, використовуючи бібліотеку createHttpError, поверніть відповідь зі статусом 400 і повідомленням 'No file'.
Використайте утиліту saveFileToCloudinary, щоб завантажити файл у Cloudinary;
Оновіть поле avatar користувача в базі даних, використовуючи отримане secure_url;
У разі успіху поверніть відповідь зі статусом 200 та об’єктом:
{ url: <посилання_на_аватар> }